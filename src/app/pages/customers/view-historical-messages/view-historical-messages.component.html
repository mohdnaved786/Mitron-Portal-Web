<div class="flex flex-col w-full max-w-xl mx-auto h-screen border overflow-hidden">
    <!-- Header -->
    <div
        class="flex items-center justify-between py-[0.45rem] px-4 bg-gradient-to-r from-cyan-300 via-green-400 via-yellow-200 to-red-300">
        <div class="flex items-center space-x-3">
            <div
                class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0 overflow-hidden flex items-center justify-center text-xs font-semibold text-gray-700">
                <ng-container *ngIf="avatar; else initials">
                    <img [src]="avatar" alt="profile" class="w-10 h-10 rounded-full" />
                </ng-container>
                <ng-template #initials>
                    {{ getInitials(name) }}
                </ng-template>
            </div>

            <div>
                <h2 class="font-semibold text-gray-800">{{ name }}</h2>
                <p class="text-sm text-gray-600">(+{{ country_code }}) {{ number }}</p>
            </div>
        </div>

        <div class="flex items-center space-x-2 w-full sm:w-auto">
            <div class="relative flex-1 sm:flex-none">
                <input type="text" placeholder="Search" [(ngModel)]="searchTerm"
                    class="w-full pl-10 py-[5px] text-sm text-[#7a8ea7] placeholder-[#7a8ea7] rounded-full focus:outline-none focus:ring-1 focus:ring-[#7a8ea7]" />
                <span
                    class="material-symbols-outlined w-4 h-4 text-[#7a8ea7] absolute left-3 top-1/2 transform -translate-y-1/2 text-[20px]">
                    search
                </span>
            </div>
            <button class="p-2 text-white">
                <i class="bi bi-chat-square-quote text-[22px]"></i>
            </button>

            <button class="p-2 text-white" (click)="close()">
                <i class="bi bi-x-lg text-[22px]"></i>
            </button>
        </div>
    </div>

    <div class="flex-1 p-4 overflow-y-auto space-y-2 bg-gray-50 relative" #chatContainer (scroll)="onScroll()">
        <div *ngIf="loading" class="text-center text-gray-500">Loading...</div>
        <div *ngIf="error" class="text-red-600">{{ error }}</div>

        <ng-container *ngFor="let item of filteredGroupedMessages">
            <!-- ðŸ”¹ Date Separator -->
            <div class="text-center my-2 text-xs text-gray-500 font-medium select-none">
                {{ item.dateLabel }}
            </div>

            <!-- ðŸ”¹ Messages for this date -->
            <div *ngFor="let msg of item.messages" class="flex" [ngClass]="{
          'justify-start': msg.sender === 'customer',
          'justify-end': msg.sender === 'user'
        }">
                <div [ngClass]="{
            'bg-[#FEF9EF] text-gray-800': msg.sender === 'customer',
            'bg-[#E3F1FF] text-gray-800': msg.sender === 'user'
          }" class="relative max-w-xs px-4 py-2 rounded-lg break-words shadow-sm">
                    <!-- Message Text / Image -->
                    <div *ngIf="msg.imageUrl">
                        <img [src]="msg.imageUrl" alt="image" class="max-w-full rounded mb-1" />
                    </div>
                    <!-- <p *ngIf="msg.text" class="text-sm me-10">{{ msg.text }}</p> -->
                    <p *ngIf="msg.text" class="text-sm me-10" [innerHTML]="highlightText(msg.text)"></p>

                    <!-- Timestamp -->
                    <span class="absolute text-[10px] text-gray-500 bottom-1 right-2 select-none ms-[20px]">
                        {{ msg.time | date : "hh:mm a" }}
                    </span>
                </div>
            </div>
        </ng-container>
    </div>

    <button *ngIf="showScrollButton === 'down'" (click)="scrollDown()"
        class="absolute w-10 h-10 bg-red-300 bottom-10 right-5 text-white rounded-full shadow-lg hover:bg-red-400 transition-all duration-300 z-50">
        <i class="bi bi-arrow-down text-lg"></i>
    </button>

    <button *ngIf="showScrollButton === 'up'" (click)="scrollUp()"
        class="absolute w-10 h-10 bg-cyan-400 bottom-10 right-5 text-white rounded-full shadow-lg hover:bg-cyan-500 transition-all duration-300 z-50">
        <i class="bi bi-arrow-up text-lg"></i>
    </button>
</div>